            radius: r, weight: 1, opacity: 0.5, fillOpacity: 0.08
          }).addTo(map);
        } else {
          myPosCircle.setLatLng(latlng);
          myPosCircle.setRadius(r);
        }
      }
    }

    function locateAndCenter({ center = true } = {}) {
      if (!("geolocation" in navigator)) {
        statusEl.textContent = "G√©olocalisation non dispo";
        return;
      }
      statusEl.textContent = "Localisation‚Ä¶";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy;

          showMyPosition(lat, lon, acc);
          if (center) map.setView([lat, lon], Math.max(map.getZoom(), 7));

          // On ne force PAS un refresh auto si OpenSky limite, mais on peut tenter une fois :
          refresh(true);
        },
        () => { statusEl.textContent = "Localisation refus√©e / indisponible"; },
        { enableHighAccuracy: false, timeout: 6000, maximumAge: 60000 }
      );
    }

    // =========================
    // Boutons: üìç + ‚Üª
    // =========================
    const Controls = L.Control.extend({
      options: { position: 'topright' },
      onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-control leaflet-control-skytrack');

        const btnLoc = L.DomUtil.create('button', '', container);
        btnLoc.type = 'button';
        btnLoc.title = 'Recentrer sur moi';
        btnLoc.innerHTML = 'üìç';

        const btnRef = L.DomUtil.create('button', '', container);
        btnRef.type = 'button';
        btnRef.title = 'Rafra√Æchir les avions';
        btnRef.innerHTML = '‚Üª';
        btnRef.style.marginTop = '8px';

        L.DomEvent.disableClickPropagation(container);

        L.DomEvent.on(btnLoc, 'click', (e) => {
          L.DomEvent.preventDefault(e);
          locateAndCenter({ center: true });
        });

        L.DomEvent.on(btnRef, 'click', (e) => {
          L.DomEvent.preventDefault(e);
          refresh(true); // force
        });

        return container;
      }
    });
    map.addControl(new Controls());

    // Centrage au chargement (si autoris√©)
    locateAndCenter({ center: true });

    // =========================
    // Markers avions
    // =========================
    function upsertMarker(id, lat, lon, heading, label) {
      const rot = (heading == null || Number.isNaN(heading)) ? 0 : heading;
      let m = markers.get(id);

      if (!m) {
        m = L.marker([lat, lon], {
          icon: planeIcon,
          rotationAngle: rot,
          rotationOrigin: "center center"
        }).addTo(map);
        markers.set(id, m);
      } else {
        m.setLatLng([lat, lon]);
        if (m.setRotationAngle) m.setRotationAngle(rot);
      }
      m.bindPopup(label);
    }

    // =========================
    // Fetch robuste (2 proxys) + gestion 429/non-JSON
    // =========================
    let inFlight = false;
    let lastFetch = 0;
    let backoffUntil = 0;

    function buildProxyUrls(bbox) {
      const upstream = `https://opensky-network.org/api/states/all?${bbox}`;
      const u = encodeURIComponent(upstream);
      return [
        `https://corsproxy.io/?${u}`,
        `https://api.allorigins.win/raw?url=${u}`
      ];
    }

    async function fetchWithFallback(urls) {
      let lastErr = null;

      for (const url of urls) {
        try {
          const res = await fetch(url, { cache: "no-store" });
          const ct = (res.headers.get("content-type") || "").toLowerCase();
          const isJson = ct.includes("application/json");

          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            if (res.status === 429 || txt.toLowerCase().includes("too many")) {
              throw new Error("429 Too many requests");
            }
            throw new Error(`HTTP ${res.status} ${txt.slice(0, 80)}`);
          }

          if (!isJson) {
            const txt = await res.text().catch(() => "");
            if (txt.toLowerCase().includes("too many")) {
              throw new Error("429 Too many requests");
            }
            throw new Error(`R√©ponse non-JSON: ${txt.slice(0, 80)}`);
          }

          return await res.json();
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error("Fetch failed");
    }

    // =========================
    // Refresh: plus de refresh sur move/zoom
    // - seulement timer 60s
    // - bouton ‚Üª pour forcer
    // - backoff si 429
    // =========================
    async function refresh(force = false) {
      const now = Date.now();
      if (inFlight) return;

      // backoff apr√®s 429
      if (!force && now < backoffUntil) {
        const s = Math.ceil((backoffUntil - now) / 1000);
        statusEl.textContent = `Limit√© (OpenSky). R√©essaie dans ${s}s`;
        return;
      }

      // anti-spam
      if (!force && now - lastFetch < 60000) return; // 60s mini
      lastFetch = now;

      try {
        inFlight = true;

        const b = map.getBounds();
        const bbox =
          `lamin=${b.getSouth()}&lomin=${b.getWest()}` +
          `&lamax=${b.getNorth()}&lomax=${b.getEast()}`;

        statusEl.textContent = "Chargement avions‚Ä¶";

        const urls = buildProxyUrls(bbox);
        const data = await fetchWithFallback(urls);

        const states = data.states || [];
        statusEl.textContent = `Avions visibles: ${states.length}`;

        const seen = new Set();

        for (const s of states) {
          const icao24 = s[0];
          const callsign = (s[1] || "").trim() || icao24;
          const lon = s[5], lat = s[6];
          const heading = s[10];
          const alt = s[13];

          if (lat == null || lon == null) continue;

          const label =
            `<b>${callsign}</b><br>` +
            `ICAO24: ${icao24}<br>` +
            `HDG: ${heading ?? "?"}<br>` +
            `ALT: ${alt ?? "?"}`;

          upsertMarker(icao24, lat, lon, heading, label);
          seen.add(icao24);
        }

        // Nettoyage
        for (const [id, m] of markers.entries()) {
          if (!seen.has(id)) {
            map.removeLayer(m);
            markers.delete(id);
          }
        }

      } catch (e) {
        const msg = String(e.message || "");
        if (msg.includes("429")) {
          // backoff 90s
          backoffUntil = Date.now() + 90000;
          statusEl.textContent = "Trop de requ√™tes (OpenSky). Attends ~1m30 puis ‚Üª.";
        } else {
          statusEl.textContent = `Erreur API/proxy (${msg.slice(0, 60)})`;
        }
        console.log(e);
      } finally {
        inFlight = false;
      }
    }

    // D√©marrage + refresh automatique toutes les 60s
    refresh(true);
    setInterval(() => refresh(false), 60000);
  </script>
</body>
</html>
