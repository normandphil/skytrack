<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkyTrack (demo)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #map { height: 100vh; }
    .hud {
      position: absolute; z-index: 9999; top: 10px; left: 10px;
      background: rgba(255,255,255,.92); padding: 10px 12px; border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,.12); max-width: 320px;
    }
    .hud b { display:block; margin-bottom:4px; }
    .hud small { color:#444; }
  </style>
</head>

<body>
  <div class="hud">
    <b>SkyTrack — demo</b>
    <small id="status">Chargement…</small>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Plugin pour rotation des markers -->
  <script src="https://unpkg.com/leaflet-rotatedmarker/leaflet.rotatedMarker.js"></script>

  <script>
    // Carte centrée sur Riga
    const map = L.map('map').setView([56.95, 24.11], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const statusEl = document.getElementById('status');
    const markers = new Map();

    // Icône avion
    const planeIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/61/61212.png',
      iconSize: [32, 32],
      iconAnchor: [16, 16],
      popupAnchor: [0, -16]
    });

    // Zone (bbox) autour de la Lettonie / Baltique
    const bbox = { lamin: 54.5, lamax: 59.8, lomin: 19.0, lomax: 29.5 };

    function upsertMarker(id, lat, lon, heading, label) {
      let m = markers.get(id);

      // Heading : si null -> 0
      const rot = (heading == null || Number.isNaN(heading)) ? 0 : heading;

      if (!m) {
        // rotatedMarker fonctionne comme L.marker mais accepte rotationAngle
        m = L.marker([lat, lon], {
          icon: planeIcon,
          rotationAngle: rot,
          rotationOrigin: "center center"
        }).addTo(map);

        markers.set(id, m);
      } else {
        m.setLatLng([lat, lon]);
        // Mise à jour rotation
        if (m.setRotationAngle) m.setRotationAngle(rot);
      }

      m.bindPopup(label);
    }

    async function refresh() {
      try {
        statusEl.textContent = "Récupération des avions…";

        const url =
          `https://opensky-network.org/api/states/all?lamin=${bbox.lamin}&lomin=${bbox.lomin}&lamax=${bbox.lamax}&lomax=${bbox.lomax}`;

        const res = await fetch(url);
        if (!res.ok) throw new Error("API error " + res.status);

        const data = await res.json();
        const states = data.states || [];

        statusEl.textContent = `Avions visibles: ${states.length} (rafraîchit toutes les 10s)`;

        const seen = new Set();

        // states format (index): 0=icao24, 1=callsign, 5=lon, 6=lat, 10=heading, 13=geo_altitude
        for (const s of states) {
          const icao24 = s[0];
          const callsign = (s[1] || "").trim() || icao24;
          const lon = s[5], lat = s[6];
          const heading = s[10];
          const alt = s[13];

          if (lat == null || lon == null) continue;

          const label =
            `<b>${callsign}</b><br>` +
            `ICAO24: ${icao24}<br>` +
            `HDG: ${heading ?? "?"}<br>` +
            `ALT: ${alt ?? "?"}`;

          upsertMarker(icao24, lat, lon, heading, label);
          seen.add(icao24);
        }

        // Nettoyage
        for (const [id, m] of markers.entries()) {
          if (!seen.has(id)) {
            map.removeLayer(m);
            markers.delete(id);
          }
        }

      } catch (e) {
        statusEl.textContent = "Erreur / limite API (réessaie)…";
        console.log(e);
      }
    }

    refresh();
    setInterval(refresh, 10000);
  </script>
</body>
</html>




